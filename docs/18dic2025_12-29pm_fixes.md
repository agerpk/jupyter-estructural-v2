# Sesión de Fixes - 18dic2025 12:29pm

## Objetivos de la Sesión

### 1. Fix: Recálculo Repetitivo de DGE
**Problema**: DGE se calcula múltiples veces innecesariamente
- Al cargar la página (restaurar vista)
- Al ejecutar "Calcular Todo"
- Cada vez que se recarga la vista

**Análisis Necesario**:
- Identificar por qué se ejecuta DGE múltiples veces
- Determinar si es por callbacks duplicados
- Verificar si es por carga de cache repetida
- Optimizar flujo para evitar cálculos redundantes

**Solución Propuesta**:
- [ ] Identificar callbacks que disparan DGE
- [ ] Implementar flag de "cálculo en progreso"
- [ ] Evitar recálculos si cache es válido
- [ ] Optimizar carga inicial de vista

---

### 2. CRÍTICO: DataFrame de Cargas No Se Genera
**Problema**: `df_cargas_completo` es None en cálculo de árboles
```
⚠️ DataFrame de cargas es None, no se guardará
```

**Importancia**: 
- El DataFrame de cargas es CRÍTICO para el output del sistema
- Contiene información detallada de todas las cargas por nodo
- Necesario para análisis y reportes completos

**Análisis Necesario**:
- Revisar dónde se debe generar `df_cargas_completo`
- Verificar si se genera en `arboles_carga.py`
- Comprobar si se pasa correctamente al guardar cache
- Identificar por qué llega como None

**Archivos a Revisar**:
- `utils/arboles_carga.py` - Generación de árboles
- `controllers/arboles_controller.py` - Orquestación
- `controllers/ejecutar_calculos.py` - Ejecución
- `utils/calculo_cache.py` - Guardado (línea 231)

**Solución Propuesta**:
- [ ] Identificar dónde se debe crear el DataFrame
- [ ] Implementar generación de `df_cargas_completo`
- [ ] Asegurar que se pase al guardar cache
- [ ] Verificar que se carga correctamente en vistas

---

## Notas de Implementación

### Estado Actual
- Sistema de cache funciona correctamente
- Gráficos se guardan y cargan bien (PNG + JSON)
- Mensajes de cache solo aparecen cuando corresponde
- FutureWarnings eliminados

### Prioridades
1. **ALTA**: DataFrame de cargas (crítico para sistema)
2. **MEDIA**: Optimizar recálculo de DGE (performance)

---

## Checklist de Verificación

### DataFrame de Cargas
- [x] Identificar función que genera DataFrame
- [x] Verificar estructura esperada (MultiIndex)
- [x] Implementar fix en ejecutar_calculos.py
- [ ] Probar guardado en cache
- [ ] Probar carga desde cache
- [ ] Verificar visualización en vista

**DIAGNÓSTICO COMPLETADO**:
- DataFrame se genera en `EstructuraAEA_Mecanica.df_cargas_completo`
- `arboles_controller.py` lo pasa correctamente ✅
- `ejecutar_calculos.py` NO lo pasa ❌ (línea 68)
- Solución: Agregar `estructura_mecanica.df_cargas_completo` al guardar

### Recálculo DGE
- [ ] Mapear todos los callbacks que usan DGE
- [ ] Identificar triggers innecesarios
- [ ] Implementar optimización
- [ ] Probar flujo completo
- [ ] Verificar que cache se usa correctamente

---

## Resultados Esperados

1. **DataFrame de cargas**: Siempre se genera y guarda correctamente
2. **DGE**: Se calcula solo cuando es necesario, no repetidamente
3. **Performance**: Mejora en tiempo de carga y ejecución
4. **Logs**: Mensajes claros sobre qué se está calculando vs cargando

---

## Seguimiento

### Cambios Realizados
- [x] Fix DataFrame de cargas en ejecutar_calculos.py
- [ ] Fix vista se reinicia al presionar "Calcular Todo" (en progreso)

### Archivos Modificados
- [x] `controllers/ejecutar_calculos.py` - Línea 68: Agregar `df_cargas_completo` al guardar cache
- [x] `controllers/calcular_todo_controller.py` - Agregar logs de debug

### Problema Nuevo Detectado
**Vista se reinicia después de calcular**:
- Callback ejecuta correctamente
- Resultados se generan
- Pero luego navegación se recarga desde cache
- Causa: Hot reload de Dash o callback de navegación disparado
- Solución: Investigar por qué se dispara navegación después del cálculo

### Testing
- [ ] Ejecutar "Calcular Todo" - verificar DataFrame
- [ ] Cargar desde cache - verificar DataFrame
- [ ] Verificar logs de DGE - no debe repetirse
- [ ] Probar flujo completo sin errores


## Fix #3: Vista Calcular Todo - Sin Carga Automática

**Problema**: Al entrar a la vista "Calcular Todo", se cargaban automáticamente los resultados desde cache, incluso antes de presionar el botón "Ejecutar Cálculo Completo".

**Causa**: El callback de navegación (`navigation_controller.py`) cargaba cache automáticamente tanto en carga inicial como al hacer clic en el menú.

**Solución**: 
- Modificado `navigation_controller.py` líneas 135-142 y 245-255
- Eliminada lógica de carga automática de cache para vista "calcular-todo"
- Ahora siempre pasa `None` como `calculo_guardado` al crear la vista
- La vista inicia vacía, esperando que el usuario presione el botón

**Comportamiento Nuevo**:
- Al entrar a "Calcular Todo": Vista vacía con botón "Ejecutar Cálculo Completo"
- Al presionar botón: Ejecuta cálculos y muestra resultados
- Al presionar "Cargar desde Cache": Carga resultados guardados

**Archivos Modificados**:
- `controllers/navigation_controller.py`

**Estado**: ✅ Completado


## Fix #2 ACTUALIZADO: DataFrame de Cargas - Generar Explícitamente

**Problema Actualizado**: El DataFrame `df_cargas_completo` era None porque el método `generar_dataframe_cargas()` NO se estaba llamando.

**Causa Raíz**: 
- `ejecutar_calculos.py` intentaba obtener `estructura_mecanica.df_cargas_completo`
- Pero el método `generar_dataframe_cargas()` nunca se ejecutaba
- El atributo quedaba en None (valor inicial línea 22 de EstructuraAEA_Mecanica.py)

**Solución Final**:
- Modificado `ejecutar_calculos.py` líneas 66-69
- Ahora verifica si `df_cargas_completo` es None
- Si es None, llama explícitamente a `estructura_mecanica.generar_dataframe_cargas()`
- Luego obtiene el DataFrame y lo pasa al cache

**Código**:
```python
# Generar DataFrame de cargas si no existe
if not hasattr(estructura_mecanica, 'df_cargas_completo') or estructura_mecanica.df_cargas_completo is None:
    estructura_mecanica.generar_dataframe_cargas()
df_cargas = estructura_mecanica.df_cargas_completo
```

**Archivos Modificados**:
- `controllers/ejecutar_calculos.py` líneas 66-69

**Estado**: ✅ Completado - Requiere prueba
